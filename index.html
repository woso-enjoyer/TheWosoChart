<!DOCTYPE html>
<html lang="en">
    <head>
        <meta property="og:title" content="WOSO Couples Chart" />
        <meta
            property="og:image"
            content="http://thewosochart.000webhostapp.com/img/wosochart.png"
        />
        <meta
            property="og:image:secure_url"
            content="https://thewosochart.000webhostapp.com/img/wosochart.png"
        />
        <title>WOSO Couples Chart</title>

        <style type="text/css">
            #mynetwork {
                width: 100%;
                height: 100%;
                border: none;
                margin: auto;
            }
            html,
            body {
                margin: 0 !important;
                padding: 0 !important;
                height: 100%;
                width: 100%;
            }
            form {
                position: absolute;
                background-color: #898989;
                z-index: 10;
                padding: 10px;
                border-radius: 0 0 5px 0;
            }
            #playerInfo {
                position:absolute;
                z-index: 10;
                background-color: #898989;
                border-radius: 0 0 5px 0;
                display: none;
                padding: 10px;
                right: 0px;
                color: white;
            }
        </style>

        <script type="text/javascript" src="vis-network.min.js"></script>

        <script type="module">
            let network;
            let lookupCount = 0;
            let nodes;
            let edges;
            let selectedNode;
            const DIR = "img/";

            const playerData = await fetch('./players.json')
            const playerDataJson = await playerData.json()
            nodes = playerDataJson.players;
            nodes.forEach(player => player.image = DIR + player.image)
            
            const relationshipData = await fetch('./relationships.json')
            const relationshipDataJson = await relationshipData.json()
            edges = relationshipDataJson.relationships;

            draw();

            function lookup() {
                const inputField = document
                    .getElementById("lname")
                    .value.toLowerCase();
                const filtered = nodes.filter(
                    (e) =>
                        e.label.toLowerCase().includes(inputField) ||
                        e.group.toLowerCase().includes(inputField)
                );
                if (filtered.length !== 0) {
                    var options = {
                        scale: 1.0,
                        offset: { x: 0, y: 0 },
                        animation: {
                            duration: 1000,
                            easingFunction: "easeInOutQuad",
                        },
                    };
                    let filteredPerson =
                        filtered[lookupCount % filtered.length];
                    network.focus(filteredPerson.id, options);
                    network.selectNodes(filtered.map((it) => it.id));
                    lookupCount += 1;
                }
            }

            window.lookup = lookup
            window.draw = draw
            window.nodes = nodes
            window.selectedNode = selectedNode

            function selectPlayer(player) {
                selectedNode = player;
                const playerInfoDiv = document.getElementById("playerInfo");
                console.log(playerInfoDiv);
                if(!selectedNode) {
                    playerInfoDiv.style.display = "none";
                } else {
                    playerInfoDiv.innerHTML = `<div>ID: ${selectedNode.id}</div><div>Name: ${selectedNode.label}</div><div>Nation: ${selectedNode.group}</div>`;
                    playerInfoDiv.style.display = "block";
                }
            }

            function draw() {
                var container = document.getElementById("mynetwork");
                var data = {
                    nodes: nodes,
                    edges: edges,
                };
                var options = {
                    nodes: {
                        shape: "dot",
                        borderWidth: 6,
                        size: 30,
                    },
                    groups: {
                        notgrouped: {
                            color: { background: "gray", border: "gray" },
                            borderWidth: 3,
                        },
                    },
                    physics: {
                        forceAtlas2Based: {
                            gravitationalConstant: -26,
                            centralGravity: 0.005,
                            springLength: 230,
                            springConstant: 0.18,
                        },
                        barnesHut: {
                            theta: 0.7,
                            gravitationalConstant: -4000,
                            centralGravity: 0.9,
                            springLength: 50,
                            springConstant: 0.08,
                            damping: 0.5,
                            avoidOverlap: 0.3,
                        },
                        repulsion: {
                            centralGravity: 0.2,
                            springLength: 180,
                            springConstant: 0.2,
                            nodeDistance: 160,
                            damping: 0.09,
                        },

                        maxVelocity: 200,
                        solver: "repulsion",
                        timestep: 0.35,
                        stabilization: { iterations: 40 },
                    },
                };
                network = new vis.Network(container, data, options);

                network.on("selectNode", function (params) {
                    const playerId = params.nodes[0];
                    if(!playerId) return;

                    const player = nodes.find(node => node.id == playerId)

                    if(!player) return;

                    selectPlayer(player)

                    console.log("selectNode Event:", selectedNode);
                });

                network.on("deselectNode", function (params) {
                    const playerId = params.nodes[0];
                    if(!playerId) {
                        selectPlayer(undefined)
                        console.log("deselectNode Event:", selectedNode);
                    }
                });
            }
        </script>
    </head>

    <body>
        <form action="javascript:;" onsubmit="lookup()">
            <input
                type="text"
                id="lname"
                name="lname"
                placeholder="Player Name"
            />
            <input type="submit" value="Search" />
        </form>
        <div id="playerInfo"></div>
        <div id="mynetwork"></div>
    </body>
</html>
